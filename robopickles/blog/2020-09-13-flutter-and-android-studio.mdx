---
title: Android Studio setup for Flutter plugin
author: Kirill Pinchuk
authorURL: https://github.com/cybergrind
tags: [flutter, android-studio, intellij-idea]
---

For our [neural network for unwrapping](https://perfectlabel.io) we've needed to run inference on phone. We have an application that is using flutter to provide cross-platform development and we needed to integrate with mobile pytorch library. We always tried to cut corners everywhere we could. But on the current stage of flutter life there are no good flutter plugins that have support for our model. Mostly plugins just re-create pytorch's mobile sample application that is classifying images. We need heatmaps.

Calling native code in flutter is super easy, so there were no big issues to implement it. So we did that.

But there are bunch of different possible outputs that can exist and we can improve existing flutter's ecosphere by separating part of internal application to plugin.

So this article is just about how to start plugin development. Unfortunately, currently flutter (1.20.3) and android-studio (3.6/4.0) aren't play together as good as they should. At least when you're using Linux. Hopefully, this could help someone.

<!--truncate-->

### Create your plugin

First, you start your plugin by triggering template.

```bash
flutter create --org com.robopickles --template plugin \
    --platforms=android,ios -a kotlin proper_pytorch
```

After this step you probably want to add everything to repository and commit just create code. Because you probably will setup-and-reset it back several times as I did.

### Open in Android Studio

First you need to install `Flutter` plugin. Then you're ready to open your project.

You have two options how to open your project:

* Import existing Flutter project. This isn't recommened by official documentation because project will be broken.
* Open existing project. This doesn't really lead to better working project in my case.

### How to understand if you got working project

First of all building and running project will work, despite code completion won't work, gradle won't work - this only affects Android Studio and doesn't prevent gradle from building correct apk.

You need to open `android/src/main/kotlin/com/robopickles/proper_pytorch/ProperPytorchPlugin.kt` and if you can navigate by Ctrl-clicking - your're good.

In my case I get:

![broken completion](/img/blog/2020-09-13-flutter-and-android-studio/01_broken_completion.png)

### Open project in Android Studio

I must admit that I'm not an expert in Android Studio internals. So I may be wrong in some cases, but here what I've found after multiple fresh installation and different attempts to fix my project.

Your biggest friend is `F4` button (`File -> Project Structure`).

You can use it to set your SDK:

![setup sdk](/img/blog/2020-09-13-flutter-and-android-studio/02_setup_sdk.png)

And check how Studio has detected your modules and dependencies in good module

![good module](/img/blog/2020-09-13-flutter-and-android-studio/03_good_module.png)

And how it looks in bad module

![bad module](/img/blog/2020-09-13-flutter-and-android-studio/04_bad_module.png)

If you restart Studio you get two notifications about missing `iml` files

![missing iml](/img/blog/2020-09-13-flutter-and-android-studio/05_no_iml_notification.png)

### Some details about Android Studio

This notifications are reasons for our problems. `flutter create` creates project from template and modules are generated by this template. You can open `.idea/modules.xml` and find such definition:

```xml
<modules>
  <module fileurl="file://$PROJECT_DIR$/proper_pytorch.iml" filepath="$PROJECT_DIR$/proper_pytorch.iml" />
  <module fileurl="file://$PROJECT_DIR$/android/proper_pytorch_android.iml" filepath="$PROJECT_DIR$/android/proper_pytorch_android.iml" />
  <module fileurl="file://$PROJECT_DIR$/example/android/proper_pytorch_example_android.iml" filepath="$PROJECT_DIR$/example/android/proper_pytorch_example_android.iml" />
</modules>
```

`IML` files are used by Android Studio to store information about module. And if we check path for broken modules - we don't find iml files on these paths.

Also, if you try to edit your modules to correct (eg. add root dir or anything else). You won't get the expected result, Studio just loose information and doesn't create missing iml files.

So, we're going to remove these things. Or you can remove modules in `Project Structure` menu.


### Workaround for kotlin module

When you have your Kotlin file opened you may notice that Flutter suggest to open it for editing (top-right menu)

![link image](/img/blog/2020-09-13-flutter-and-android-studio/06_open_for_editing.png)

This will open module as a new project and magically detect gradle (on the right side)

![gradle detected](/img/blog/2020-09-13-flutter-and-android-studio/07_gradle_detected.png)

Also it will setup all harned and add all dependencies. Thus Kotlin's completion starts work.

This enables at least basic editing for Android code withing Studio.


And it will generate `iml` for this module inside nested under `example/android/.idea/modules/` directory. Unfortunately, you cannot get you main project working by importing this iml file directly.

### Fixing main project

Remove auto-generated `.idea` directory. Commit it as a clear state.

Open `Settings -> Build,Exectuion,Deployment -> Build Tools -> Gradle` and opt-in `Generate *.iml files`.

![generate iml](/img/blog/2020-09-13-flutter-and-android-studio/08_generate_iml.png)

Then you need run your application once. This will generate all required gradle files.

Set your project sdk in `Project Structure -> Project` to Android SDK.

After that you can import `build.gradle` from `example/android` directory.

![import gradle](/img/blog/2020-09-13-flutter-and-android-studio/09_import_gradle.png)

After that you should see a lot of libraries in Project window on the bottom of the view.

This will enable code completion. Unfortunately some things (eg. running tests from Studio) still may fail. To fix that you need to restart Studio.

So, correct project will have 3 additional `iml` files and `.idea` directory also will have `gradle.xml`.

![new .idea dir](/img/blog/2020-09-13-flutter-and-android-studio/10_good_idea.png)

### Afterword

As the result of all our manipulation we will have broken `Project Structure` menu, but rest of things seem to be working.

